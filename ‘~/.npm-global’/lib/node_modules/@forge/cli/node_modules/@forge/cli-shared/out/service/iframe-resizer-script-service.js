"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.IframeResizerScriptService = void 0;
const cheerio_1 = require("cheerio");
const gateway_1 = require("../graphql/gateway");
const IFRAME_RESIZER_CDN_PATH = 'iframeResizer.contentWindow.min.js';
const GLOBAL_FORGE_INSTALL_ID = 'forge';
class IframeResizerScriptService {
    env;
    constructor(env = (0, gateway_1.getEnvironmentConfig)(gateway_1.CDNEnvironments)) {
        this.env = env;
    }
    createIframeResizerScriptTag() {
        return `<script async src="https://${GLOBAL_FORGE_INSTALL_ID}.cdn.${this.env}.atlassian-dev.net/${IFRAME_RESIZER_CDN_PATH}"></script>`;
    }
    injectIframeResizer(content, onError) {
        const $ = (0, cheerio_1.load)(content, { xml: { xmlMode: false } });
        if ($('html').length === 0)
            onError();
        let head = $('head');
        if (head.length === 0) {
            $('html').prepend('<head></head>');
            head = $('head');
        }
        head.prepend(this.createIframeResizerScriptTag());
        return Buffer.from($.html());
    }
}
exports.IframeResizerScriptService = IframeResizerScriptService;
