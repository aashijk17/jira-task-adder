"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.BridgeScriptService = void 0;
const cheerio_1 = require("cheerio");
const gateway_1 = require("../graphql/gateway");
const BRIDGE_CORE_CDN_PATH = 'global-bridge.js';
const GLOBAL_FORGE_INSTALL_ID = 'forge';
class BridgeScriptService {
    env;
    constructor(env = (0, gateway_1.getEnvironmentConfig)(gateway_1.CDNEnvironments)) {
        this.env = env;
    }
    createBridgeCoreScriptTag() {
        return `<script src="https://${GLOBAL_FORGE_INSTALL_ID}.cdn.${this.env}.atlassian-dev.net/${BRIDGE_CORE_CDN_PATH}"></script>`;
    }
    injectBridgeCore(content, onError) {
        const $ = (0, cheerio_1.load)(content, { xml: { xmlMode: false } });
        if ($('html').length === 0)
            onError();
        let head = $('head');
        if (head.length === 0) {
            $('html').prepend('<head></head>');
            head = $('head');
        }
        head.prepend(this.createBridgeCoreScriptTag());
        return Buffer.from($.html());
    }
}
exports.BridgeScriptService = BridgeScriptService;
